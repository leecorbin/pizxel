"""
ZX Spectrum-style font system for LED matrix display.
8x8 pixel characters with RGB color support.
"""

from typing import Tuple, Union, Optional, Dict
from matrixos.display import Display


# Type alias for color
Color = Union[bool, Tuple[int, int, int]]


class Font:
    """
    Font class for rendering text on LED matrix.
    Based on ZX Spectrum 8x8 character set.
    """

    def __init__(self):
        """Initialize font with ZX Spectrum character set."""
        self.char_width = 8
        self.char_height = 8
        self.charset = {}
        self.custom_chars = {}

        # Load default ZX Spectrum font
        self._load_zx_spectrum_font()

    def _load_zx_spectrum_font(self):
        """
        Load authentic ZX Spectrum font data from ROM.
        Each character is 8x8 pixels, stored as 8 bytes (one per row).
        Each bit represents a pixel (1 = on, 0 = off).

        This is the official ZX Spectrum ROM font (addresses $3C00-$3FFF).
        Characters naturally have ~6x6 pixel glyphs with spacing built in.
        """
        # Official ZX Spectrum ROM Font Data
        # Format: character: [8 bytes, each byte is a row of 8 pixels]

        self.charset = {
            # Space and punctuation (ASCII 32-47)
            ' ': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
            '!': [0x00, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00],
            '"': [0x00, 0x24, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00],
            '#': [0x00, 0x24, 0x7E, 0x24, 0x24, 0x7E, 0x24, 0x00],
            '$': [0x00, 0x08, 0x3E, 0x28, 0x3E, 0x0A, 0x3E, 0x08],
            '%': [0x00, 0x62, 0x64, 0x08, 0x10, 0x26, 0x46, 0x00],
            '&': [0x00, 0x10, 0x28, 0x10, 0x2A, 0x44, 0x3A, 0x00],
            "'": [0x00, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00],
            '(': [0x00, 0x04, 0x08, 0x08, 0x08, 0x08, 0x04, 0x00],
            ')': [0x00, 0x20, 0x10, 0x10, 0x10, 0x10, 0x20, 0x00],
            '*': [0x00, 0x00, 0x14, 0x08, 0x3E, 0x08, 0x14, 0x00],
            '+': [0x00, 0x00, 0x08, 0x08, 0x3E, 0x08, 0x08, 0x00],
            ',': [0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x10],
            '-': [0x00, 0x00, 0x00, 0x00, 0x3E, 0x00, 0x00, 0x00],
            '.': [0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00],
            '/': [0x00, 0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x00],

            # Numbers (ASCII 48-57)
            '0': [0x00, 0x3C, 0x46, 0x4A, 0x52, 0x62, 0x3C, 0x00],
            '1': [0x00, 0x18, 0x28, 0x08, 0x08, 0x08, 0x3E, 0x00],
            '2': [0x00, 0x3C, 0x42, 0x02, 0x3C, 0x40, 0x7E, 0x00],
            '3': [0x00, 0x3C, 0x42, 0x0C, 0x02, 0x42, 0x3C, 0x00],
            '4': [0x00, 0x08, 0x18, 0x28, 0x48, 0x7E, 0x08, 0x00],
            '5': [0x00, 0x7E, 0x40, 0x7C, 0x02, 0x42, 0x3C, 0x00],
            '6': [0x00, 0x3C, 0x40, 0x7C, 0x42, 0x42, 0x3C, 0x00],
            '7': [0x00, 0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x00],
            '8': [0x00, 0x3C, 0x42, 0x3C, 0x42, 0x42, 0x3C, 0x00],
            '9': [0x00, 0x3C, 0x42, 0x42, 0x3E, 0x02, 0x3C, 0x00],

            # More punctuation (ASCII 58-64)
            ':': [0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x00],
            ';': [0x00, 0x00, 0x10, 0x00, 0x00, 0x10, 0x10, 0x20],
            '<': [0x00, 0x00, 0x04, 0x08, 0x10, 0x08, 0x04, 0x00],
            '=': [0x00, 0x00, 0x00, 0x3E, 0x00, 0x3E, 0x00, 0x00],
            '>': [0x00, 0x00, 0x10, 0x08, 0x04, 0x08, 0x10, 0x00],
            '?': [0x00, 0x3C, 0x42, 0x04, 0x08, 0x00, 0x08, 0x00],
            '@': [0x00, 0x3C, 0x4A, 0x56, 0x5E, 0x40, 0x3C, 0x00],

            # Uppercase letters (ASCII 65-90)
            'A': [0x00, 0x18, 0x24, 0x42, 0x42, 0x7E, 0x42, 0x00],
            'B': [0x00, 0x7C, 0x42, 0x7C, 0x42, 0x42, 0x7C, 0x00],
            'C': [0x00, 0x3C, 0x42, 0x40, 0x40, 0x42, 0x3C, 0x00],
            'D': [0x00, 0x78, 0x44, 0x42, 0x42, 0x44, 0x78, 0x00],
            'E': [0x00, 0x7E, 0x40, 0x7C, 0x40, 0x40, 0x7E, 0x00],
            'F': [0x00, 0x7E, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x00],
            'G': [0x00, 0x3C, 0x42, 0x40, 0x4E, 0x42, 0x3C, 0x00],
            'H': [0x00, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00],
            'I': [0x00, 0x3E, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00],
            'J': [0x00, 0x02, 0x02, 0x02, 0x42, 0x42, 0x3C, 0x00],
            'K': [0x00, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00],
            'L': [0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00],
            'M': [0x00, 0x42, 0x66, 0x5A, 0x42, 0x42, 0x42, 0x00],
            'N': [0x00, 0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x00],
            'O': [0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00],
            'P': [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x00],
            'Q': [0x00, 0x3C, 0x42, 0x42, 0x52, 0x4A, 0x3C, 0x00],
            'R': [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x44, 0x42, 0x00],
            'S': [0x00, 0x3C, 0x40, 0x3C, 0x02, 0x42, 0x3C, 0x00],
            'T': [0x00, 0xFE, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00],
            'U': [0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00],
            'V': [0x00, 0x42, 0x42, 0x42, 0x42, 0x24, 0x18, 0x00],
            'W': [0x00, 0x42, 0x42, 0x42, 0x42, 0x5A, 0x24, 0x00],
            'X': [0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00],
            'Y': [0x00, 0x82, 0x44, 0x28, 0x10, 0x10, 0x10, 0x00],
            'Z': [0x00, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x7E, 0x00],

            # Brackets and symbols (ASCII 91-96)
            '[': [0x00, 0x0E, 0x08, 0x08, 0x08, 0x08, 0x0E, 0x00],
            '\\': [0x00, 0x00, 0x40, 0x20, 0x10, 0x08, 0x04, 0x00],
            ']': [0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x70, 0x00],
            '^': [0x00, 0x10, 0x38, 0x54, 0x10, 0x10, 0x10, 0x00],  # Arrow up (â†‘) in ZX Spectrum
            '_': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF],
            '`': [0x00, 0x1C, 0x22, 0x78, 0x20, 0x20, 0x7E, 0x00],  # Pound sign (Â£) at ASCII 0x60 in ZX Spectrum

            # Lowercase letters (ASCII 97-122)
            'a': [0x00, 0x00, 0x38, 0x04, 0x3C, 0x44, 0x3C, 0x00],
            'b': [0x00, 0x20, 0x20, 0x3C, 0x22, 0x22, 0x3C, 0x00],
            'c': [0x00, 0x00, 0x1C, 0x20, 0x20, 0x20, 0x1C, 0x00],
            'd': [0x00, 0x04, 0x04, 0x3C, 0x44, 0x44, 0x3C, 0x00],
            'e': [0x00, 0x00, 0x38, 0x44, 0x78, 0x40, 0x3C, 0x00],
            'f': [0x00, 0x0C, 0x10, 0x18, 0x10, 0x10, 0x10, 0x00],
            'g': [0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x38],
            'h': [0x00, 0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x00],
            'i': [0x00, 0x10, 0x00, 0x30, 0x10, 0x10, 0x38, 0x00],
            'j': [0x00, 0x04, 0x00, 0x04, 0x04, 0x04, 0x24, 0x18],
            'k': [0x00, 0x20, 0x28, 0x30, 0x30, 0x28, 0x24, 0x00],
            'l': [0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x0C, 0x00],
            'm': [0x00, 0x00, 0x68, 0x54, 0x54, 0x54, 0x54, 0x00],
            'n': [0x00, 0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00],
            'o': [0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00],
            'p': [0x00, 0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40],
            'q': [0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x06],
            'r': [0x00, 0x00, 0x1C, 0x20, 0x20, 0x20, 0x20, 0x00],
            's': [0x00, 0x00, 0x38, 0x40, 0x38, 0x04, 0x78, 0x00],
            't': [0x00, 0x10, 0x38, 0x10, 0x10, 0x10, 0x0C, 0x00],
            'u': [0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00],
            'v': [0x00, 0x00, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00],
            'w': [0x00, 0x00, 0x44, 0x54, 0x54, 0x54, 0x28, 0x00],
            'x': [0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00],
            'y': [0x00, 0x00, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x38],
            'z': [0x00, 0x00, 0x7C, 0x08, 0x10, 0x20, 0x7C, 0x00],

            # Final symbols (ASCII 123-127)
            '{': [0x00, 0x0E, 0x08, 0x30, 0x08, 0x08, 0x0E, 0x00],
            '|': [0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00],
            '}': [0x00, 0x70, 0x10, 0x0C, 0x10, 0x10, 0x70, 0x00],
            '~': [0x00, 0x14, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00],
            '\x7f': [0x0F, 0x09, 0x0F, 0x09, 0x0F, 0x09, 0x09, 0x00],  # Copyright (Â©) at ASCII 0x7F in ZX Spectrum

            # ZX Spectrum block graphics (UK Pound sign and copyright as examples)
            'Â£': [0x18, 0x24, 0x20, 0x70, 0x20, 0x20, 0x7C, 0x00],
            'Â©': [0x38, 0x44, 0x9C, 0xA4, 0x9C, 0x44, 0x38, 0x00],

            # Block graphics characters (quarter blocks - ZX Spectrum style)
            'â–˜': [0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00],  # Upper left quadrant
            'â–': [0x0F, 0x0F, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00],  # Upper right quadrant
            'â––': [0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0],  # Lower left quadrant
            'â–—': [0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x0F, 0x0F],  # Lower right quadrant
            'â–š': [0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x0F, 0x0F],  # Diagonal
            'â–ž': [0x0F, 0x0F, 0x0F, 0x0F, 0xF0, 0xF0, 0xF0, 0xF0],  # Other diagonal
            'â–ˆ': [0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF],  # Full block
            'â–€': [0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00],  # Upper half
            'â–„': [0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF],  # Lower half
            'â–Œ': [0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0],  # Left half
            'â–': [0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F, 0x0F],  # Right half
            
            # Extended MatrixOS glyphs - UI elements
            'â†’': [0x00, 0x10, 0x08, 0x7E, 0x08, 0x10, 0x00, 0x00],  # Right arrow
            'â†': [0x00, 0x08, 0x10, 0x7E, 0x10, 0x08, 0x00, 0x00],  # Left arrow
            'â†“': [0x00, 0x18, 0x18, 0x18, 0x7E, 0x3C, 0x18, 0x00],  # Down arrow
            'â†‘': [0x00, 0x18, 0x3C, 0x7E, 0x18, 0x18, 0x18, 0x00],  # Up arrow (duplicate of ^)
            'âœ“': [0x00, 0x00, 0x02, 0x04, 0x48, 0x30, 0x00, 0x00],  # Checkmark
            'âœ—': [0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00],  # X mark
            'â—': [0x00, 0x18, 0x3C, 0x3C, 0x3C, 0x18, 0x00, 0x00],  # Filled circle
            'â—‹': [0x00, 0x18, 0x24, 0x24, 0x24, 0x18, 0x00, 0x00],  # Empty circle
            'â—†': [0x00, 0x10, 0x28, 0x44, 0x28, 0x10, 0x00, 0x00],  # Diamond
            'â˜…': [0x10, 0x10, 0x7C, 0x38, 0x6C, 0x44, 0x00, 0x00],  # Star
            'â™¥': [0x00, 0x28, 0x7C, 0x7C, 0x38, 0x10, 0x00, 0x00],  # Heart
            'â™ª': [0x00, 0x04, 0x06, 0x05, 0x04, 0x3C, 0x3C, 0x00],  # Music note
            
            # Progress/battery indicators
            'â–': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF],  # 1/8 block
            'â–‚': [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF],  # 2/8 block
            'â–ƒ': [0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF],  # 3/8 block
            'â–…': [0x00, 0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF],  # 5/8 block
            'â–†': [0x00, 0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF],  # 6/8 block
            'â–‡': [0x00, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF],  # 7/8 block
            
            # Box drawing characters
            'â”‚': [0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18],  # Vertical line
            'â”€': [0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00],  # Horizontal line
            'â”Œ': [0x00, 0x00, 0x00, 0xFF, 0x18, 0x18, 0x18, 0x18],  # Top left corner
            'â”': [0x00, 0x00, 0x00, 0xFF, 0x18, 0x18, 0x18, 0x18],  # Top right corner
            'â””': [0x18, 0x18, 0x18, 0xFF, 0x00, 0x00, 0x00, 0x00],  # Bottom left corner
            'â”˜': [0x18, 0x18, 0x18, 0xFF, 0x00, 0x00, 0x00, 0x00],  # Bottom right corner
            'â”œ': [0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18],  # Left T
            'â”¤': [0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18],  # Right T
            'â”¬': [0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00],  # Top T
            'â”´': [0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00],  # Bottom T
            'â”¼': [0x18, 0x18, 0x18, 0xFF, 0x18, 0x18, 0x18, 0x18],  # Cross
            
            # Status icons
            'ðŸ”‹': [0x3C, 0x24, 0x24, 0xFF, 0x81, 0x81, 0xFF, 0x00],  # Battery
            'ðŸ“¶': [0x00, 0x40, 0x60, 0x70, 0x78, 0x7C, 0x7E, 0x00],  # Signal bars
            'ðŸ”’': [0x00, 0x3C, 0x24, 0x7E, 0x42, 0x42, 0x7E, 0x00],  # Lock
            'ðŸ”“': [0x00, 0x3C, 0x20, 0x7E, 0x42, 0x42, 0x7E, 0x00],  # Unlock
            'âš™': [0x00, 0x54, 0x38, 0x7C, 0x38, 0x54, 0x00, 0x00],  # Gear/settings
            'ðŸ ': [0x00, 0x18, 0x3C, 0x7E, 0x66, 0x66, 0x7E, 0x00],  # Home
            'ðŸŽ®': [0x3C, 0x42, 0xA5, 0x81, 0x99, 0x42, 0x3C, 0x00],  # Game controller
            'ðŸ•': [0x3C, 0x42, 0x81, 0x89, 0x8D, 0x42, 0x3C, 0x00],  # Clock
            'â˜€': [0x92, 0x54, 0x38, 0xFE, 0x38, 0x54, 0x92, 0x00],  # Sun
            'â˜': [0x00, 0x30, 0x48, 0xFE, 0x01, 0x01, 0x00, 0x00],  # Cloud
            'â˜‚': [0x38, 0x54, 0x92, 0x10, 0x10, 0x10, 0x60, 0x00],  # Umbrella/rain
            'â„': [0x10, 0x54, 0x38, 0xFE, 0x38, 0x54, 0x10, 0x00],  # Snowflake
            'âš¡': [0x00, 0x18, 0x10, 0x3E, 0x04, 0x0C, 0x00, 0x00],  # Lightning
            'ðŸŒ¡': [0x1C, 0x14, 0x14, 0x14, 0x34, 0x36, 0x1C, 0x00],  # Thermometer
        }


    def register_char(self, char: str, bitmap: list):
        """
        Register a custom character or icon.

        Args:
            char: Single character or identifier
            bitmap: List of 8 integers (0-255), each representing a row of 8 pixels
        """
        if len(bitmap) != 8:
            raise ValueError("Bitmap must be exactly 8 rows")

        self.custom_chars[char] = bitmap

    def get_char_bitmap(self, char: str) -> Optional[list]:
        """
        Get bitmap for a character.

        Args:
            char: Character to look up

        Returns:
            List of 8 bytes representing the character, or None if not found
        """
        # Check custom characters first
        if char in self.custom_chars:
            return self.custom_chars[char]

        # Then check default charset
        if char in self.charset:
            return self.charset[char]

        # Return space if character not found
        return self.charset.get(' ')

    def draw_char(self, display: Display, char: str, x: int, y: int,
                  color: Color = True, bg_color: Optional[Color] = None):
        """
        Draw a single character at pixel position.

        Args:
            display: Display instance
            char: Character to draw
            x, y: Top-left pixel position
            color: Foreground color
            bg_color: Background color (None = transparent)
        """
        bitmap = self.get_char_bitmap(char)
        if not bitmap:
            return

        for row in range(8):
            byte = bitmap[row]
            for col in range(8):
                # Check if pixel is set (bit is 1)
                if byte & (0x80 >> col):
                    display.set_pixel(x + col, y + row, color)
                elif bg_color is not None:
                    # Draw background
                    display.set_pixel(x + col, y + row, bg_color)

    def draw_text(self, display: Display, text: str, x: int, y: int,
                  color: Color = True, bg_color: Optional[Color] = None, spacing: int = 0):
        """
        Draw text string at pixel position.

        Args:
            display: Display instance
            text: Text to draw
            x, y: Top-left pixel position
            color: Foreground color
            bg_color: Background color (None = transparent)
            spacing: Additional spacing between characters
        """
        cursor_x = x
        for char in text:
            self.draw_char(display, char, cursor_x, y, color, bg_color)
            cursor_x += self.char_width + spacing

    def draw_text_grid(self, display: Display, text: str, col: int, row: int,
                       color: Color = True, bg_color: Optional[Color] = None):
        """
        Draw text at character grid position (8x8 grid for 64x64 display).

        Args:
            display: Display instance
            text: Text to draw
            col, row: Character grid position (0-7 for 64x64)
            color: Foreground color
            bg_color: Background color (None = transparent)
        """
        x = col * self.char_width
        y = row * self.char_height
        self.draw_text(display, text, x, y, color, bg_color)

    def fill_text_buffer(self, display: Display, lines: list,
                        color: Color = True, bg_color: Optional[Color] = None):
        """
        Fill entire display with text in grid mode (like ZX-81 text mode).

        Args:
            display: Display instance
            lines: List of strings, one per row
            color: Foreground color
            bg_color: Background color (None = transparent)
        """
        max_rows = display.height // self.char_height
        max_cols = display.width // self.char_width

        for row_idx, line in enumerate(lines[:max_rows]):
            # Pad or truncate line to fit
            padded_line = line[:max_cols].ljust(max_cols)
            self.draw_text_grid(display, padded_line, 0, row_idx, color, bg_color)


# Global default font instance
default_font = Font()
